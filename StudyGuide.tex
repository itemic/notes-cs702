\documentclass[12pt,a4paper]{article}
\usepackage{blindtext}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage[margin=0.65in]{geometry}
\usepackage{multicol}
\usepackage{wrapfig}
\usepackage[dvipsnames]{xcolor}
\usepackage{framed}
\usepackage[most]{tcolorbox}
\usepackage{pgfgantt}
\usepackage{tikz}
\usetikzlibrary{arrows.meta}
\usepackage[dvipsnames]{xcolor}
\definecolor{aliceblue}{rgb}{0.94, 0.97, 1.0}
\colorlet{shadecolor}{aliceblue}
\setlength\parindent{0pt}
\usepackage{charter}
\usepackage{environ}
\usepackage{tikz}
\usetikzlibrary{calc,matrix}
\usetikzlibrary{positioning,fit,calc}
\usepackage{float}
\usepackage{url}
\usepackage{pifont}
\usepackage{tabularx}
\providecommand*{\checkmark}{\ding{51}}
% code by Andrew:
% http://tex.stackexchange.com/a/28452/13304
\makeatletter
\let\matamp=&
\catcode`\&=13
\makeatletter
\def&{\iftikz@is@matrix
	\pgfmatrixnextcell
	\else
	\matamp
	\fi}
\makeatother

\newcounter{lines}
\def\endlr{\stepcounter{lines}\\}

\title{COMPSCI 702 - Security for Smart-devices}
\date{Semester 1, 2018}
\begin{document}
\maketitle
\tableofcontents{}

\section*{Disclaimer}
\textit{This study guide is based off the lecture slides prepared for CS702. It is provided as-is and may contain errors, though effort has been made to minimize this. This resource is not exhaustive and may not contain additional content not covered by the slides.}
\newpage

\section{Access Control}
\subsection{Security objectives}
\begin{shaded}
\begin{itemize}
	\item \textbf{Confidentiality.} Protection of the data.
	\item \textbf{Integrity.} Ensure data is not altered by unauthorized parties.
	\item \textbf{Availability.} Ensure timely access to data.
	\item \textbf{Authentication.} Identify whether communicating entity is who it claims to be.
	\item \textbf{Authorization.} Regulate access to data.
\end{itemize}
\end{shaded}
\subsection{Access control requirements}
The inputs need to be \textit{reliable}, with authenticated entities or genuine information. The \textbf{principle of least privileges} grants the minimum set of access rights to do a job. Furthermore, only a special entity (administrator) can manage (grant/revoke/update) access rights.
\subsection{Elements of access control}
\begin{shaded}
\begin{itemize}
	\item \textbf{Subject.} An entity that can access objects. It can be a user or a process representing a user or an application.
	\item \textbf{Object.} An entity (file, directory, resource) that needs to be protected.
	\item \textbf{Access right.} An access right $r \in R$ describes how a subject $s \in S$ can access an object $o \in O$. Examples include: read, write, execute, create, delete, search, etc.
	\item \textbf{Access control function $f(s, o, r)$} looks up the access right $r$ for combination $(s, o)$. It grants access on a successful match.
	\item \textbf{Security administrator.} Entity that manages access rights.
	\item \textbf{Auditor.} Entity that inspects whole authorization system.
\end{itemize}	
\end{shaded}
\subsection{Access control models}
There are 5 main models for access control:
\begin{itemize}
	\item Discretionary access control (DAC),
	\item Mandatory access control (MAC),
	\item Role-based access control (RBAC),
	\item Usage control (UCON), and
	\item Policy-based access control (PBAC).
\end{itemize}
\subsubsection{Discretionary access control}
Users can protect what they own. The owner can grant access to subjects. Access is granted based on the identity of the requester. These mechanisms are adequate for honest users, but are vulnerable to Trojan horses.\\

DAC is used in operating systems and DBMS. An example is Linux file permissions: \texttt{rwxr-x--x}.

\subsubsection*{Access control matrix}
\begin{shaded}
\begin{center}
\begin{tabular}{lllll}
                            & File 1                                                                            & File 2                                                                            & File 3                                                                            & File 4                                                                          \\ \cline{2-5} 
\multicolumn{1}{l|}{User A} & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}owner\\ read\\ write\end{tabular}} & \multicolumn{1}{l|}{}                                                             & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}owner\\ read\\ write\end{tabular}} & \multicolumn{1}{l|}{}                                                           \\ \cline{2-5} 
\multicolumn{1}{l|}{User B} & \multicolumn{1}{l|}{read}                                                         & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}owner\\ read\\ write\end{tabular}} & \multicolumn{1}{l|}{write}                                                        & \multicolumn{1}{l|}{read}                                                       \\ \cline{2-5} 
\multicolumn{1}{l|}{User C} & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}read\\ write\end{tabular}}         & \multicolumn{1}{l|}{read}                                                         & \multicolumn{1}{l|}{}                                                             & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}own\\ read\\ write\end{tabular}} \\ \cline{2-5} 
\end{tabular}
\end{center}
An \textbf{access control list}	is a list of access rights on an object. A \textbf{capability list} refers to a user's permissions on different objects. In the diagram, columns are ACLs and rows are capability lists.
\end{shaded}
\subsubsection{Mandatory access control}
MAC restricts access on the basis of security labels. Entities cannot enable other entities to access their resources. Users have security clearance, and resources have security labels that contain data classification.\\

This model is used when information classification and confidentiality are very important, such as in the military. The \textbf{Bell-LaPadula model} (BLP) is used in the US Department of Defence. The \textbf{Biba model} is implemented in the FreeBSD MAC policy. A combined version is used in Android.

\subsubsection*{Bell-LaPadula model}
Goal: Control \textbf{confidentiality of information}.
\begin{itemize}
	\item \textbf{Simple security property.} No read up.
	\item \textbf{*(Star)property.} No write down.
	\item \textbf{Strong *(star)property} No write down and no write up.
\end{itemize}

\subsubsection*{Biba integrity model}
Goal: Control \textbf{integrity of information}.
\begin{itemize}
	\item \textbf{Simple integrity axiom.} No read down.
	\item \textbf{*(Star)-integrity axiom.} No write up.
\end{itemize}
\subsubsection{Role-based access control}
RBAC maps roles to access rights. Supports complex access control. Reduces administrative errors. Flexible to move users or permissions in/out of roles. Least privilege; restrict access according to needs.

\subsubsection*{RBAC model}
\begin{shaded}
\begin{itemize}
	\item \textbf{User.} A human being. Usually. They are assigned roles (\textbf{user assignment, UA}).
	\item \textbf{Permissions.} Approval of a mode of access to some object. They represent what operations could be performed on objects.
	\item \textbf{Roles.} Job title. Roles are assigned permissions (\textbf{permission assignment, PA}).
	\item \textbf{Assignments.} User-role and role-permission.
	\item \textbf{Session.} Mapping between user and an activated subset of assigned roles.
	\item \textbf{Constraints.} Constraintsd are present on sessions, assignments, and roles.
\end{itemize}	
\end{shaded}

\begin{tikzpicture}[title/.style={font=\fontsize{8}{8}\color{black!50}\ttfamily}]
\node (h) at (12, 1) [title] {Permissions};
\node (a) at (0, 2) [rectangle, draw] {Users};
\node (b) at (4, 2) [rectangle, draw] {Roles};
\node (c) at (2, 0) [rectangle, draw] {Sessions};
\node (d) at (10, 2) [rectangle, draw] {Operations};
\node (e) at (14, 2) [rectangle, draw] {Objects};
\node (f) at (8, 2) [rectangle, draw, fit={(h) (d) (e)}] {};
\draw [<<->>] (a) -- (b) node [midway, fill=white] {UA};
\draw [<<->>] (a) -- (c);
\draw [<<->>] (b) -- (c);
\draw [<<->>] (b) -- (f) node [midway, fill=white] {PA};
\draw [<<->>] (d) -- (e);
\end{tikzpicture}

\subsubsection*{Controlling usage of resources}
DAC, MAC, and RBAC are concerned with checking access rights of entities. Once the access is granted, no more control is enforced.

\subsubsection{Usage control}
UCON doesn't just regulate access to an object, but also focuses on controlling usage. Addresses DRM. DAC, MAC, and RBAC can be expressed by UCON.

\subsubsection*{UCON model}
\begin{shaded}
\begin{itemize}
	\item \textbf{Subjects.} Entities that perform actions.
	\item \textbf{Objects.} Entities accessed by subjects.
	\item \textbf{Rights.} Set of actions.
	\item \textbf{Authorization.} Functional predicates that have to be evaluated for usage decision.
	\item \textbf{Obligations.} Functional predicates that verify mandatory requirements that must have been performed by subject.
	\item \textbf{Conditions.} Environmental/system based decision factors (time, status, etc.)
\end{itemize}	
\end{shaded}
\subsubsection{Policy-based access control}
In PBAC, an authorization policy governs access rights of subjects over objects. Policies are specified independently of entities. This provides a coherent view of access control in a system, and a separation between AC logic and enforcement mechanism.\\

An approach is XACML.

\subsubsection*{PBAC entities}
\begin{itemize}
	\item \textbf{Policy administrator.} Administrates access policies.
	\item \textbf{Policy administration point (PAP).} Interface for policy administration.
	\item \textbf{Policy store.} Repository to store policies.
	\item \textbf{Subject.} Entity that makes access requests.
	\item \textbf{Resources.} Target objects requested by subject.
	\item \textbf{Policy enforcement point (PEP).} Enforces access policies and grants access to resources.
	\item \textbf{Policy decision point (PDP).} Evaluates access policies.
	\item \textbf{Policy information point (PIP).} Provides contextual information.
\end{itemize}
\section{Android Security}
\subsection{Introduction to Android}
Android is a smartphone (open-source) OS currently developed by Google based on the Linux kernel. The SDK was released in November 2007 for Java, followed by the NDK (native development kit) in June 2009 for C and C++. The \textbf{Open Handset Alliance} is a consortium of 84 firms for developing open standards for mobile devices.\\

Android \textbf{fragmentation} is a problem. Vendors can customize the OS for their own devices by including their own apps. Some of these apps may compromise security/privacy as they have technical vulnerabilities. Vendors also might not push updates as frequently, and leave devices a few versions behind. Some vendors stop supporting their devices afterwards as well. \textit{The lack of support can lead to vulnerabilities.}\\

Android is considered \textbf{middleware} between the Linux kernel and its set of APIs. Android apps are mainly written in Java, and only Android apps can run on Android devices. Through the APIs, apps can access device information/components.

\includegraphics[width=\textwidth]{graphics/androidanatomy}

\paragraph{Linux kernel}
Android is built on the Linux kernel\footnote{It is \textbf{not} Linux.}. There is no \texttt{glibc} support, nor does it include the full set of Linux utilities. There are some kernel enhancements.\\

The Linux kernel was chosen as it has great memory/process management. It also has a permissions-based security model, a proven driver model, support for shared libraries. The Linux kernel is also open-source.

\paragraph{Binder}
Applications and services may run in separate processes but must communicate and share data. \textbf{Issue:} Inter-process communication (IPC) can introduce significant processing overhead and security holes. \textbf{Solution:} Driver to facilitate IPC.

\paragraph{Power management}
Mobile devices run on battery power with limited capacity. The power management features are built on top of Linux power management, but has more aggressive power management policy.

\subsubsection*{Native libraries}
Bionic \texttt{libc} is a custom \texttt{libc} implementation.\\

Why Bionic? \texttt{glibc} is licensed under LGPL, which prevents static linking of proprietary software. The size needs to be small as it will load in each process, and needs to be efficiency due to limited CPU power. \textbf{Bionic \texttt{libc}} is under the BSD license, is small, and efficient due to a custom pthread implementation. It does not support some POSIX features, is not compatible with \texttt{glibc}, and all native code must be compiled against Bionic.

\subsubsection*{Hardware abstraction layer}
This layer is a user-space C/C++ layer which separates the Android platform logic from the hardware interface.\\

A user-space HAL is necessary as 1) not all components have standardized kernel driver interfaces; 2) kernel drivers are licensed under GPL, which exposes any proprietary IP; and 3) Android has specific requirements for hardware drivers.

\subsubsection*{Android runtime}
\paragraph{Dalvik VM}
Android's custom clean room implementation. Provides application portability and runtime consistency. This runs Dalvik bytecode (optimized file format \texttt{.dex}). Java \texttt{.class}/\texttt{.jar} files are converted to \texttt{.dex} at build time.\\

The VM is also designed for embedded environment. It supports multiple virtual machine processes per device. It has a highly CPU-optimized bytecode interpreter, and uses runtime memory very efficiently.

\paragraph{Core libraries}
These are Core APIs for Java which provide a powerful and simple/familiar development platform. They are basically Java wrappers around C/C++ based libraries.

\subsubsection*{Application framework}
These are services essential for Android. Apps don't access them directly.

\subsubsection*{Applications}
These are applications.

\subsubsection{Runtime}
At startup, the bootloader loads the Linux kernel and starts the \texttt{init} process. The \texttt{init} process starts the \textbf{zygote} process, a nascent process that initializes a Dalvik VM instance. It forks on request to create VM instances for managed processes. It uses copy-on-write to maximize re-use and minimize footprint. \textit{There is an instance of DalvikVM per APK.}\\

\begin{tikzpicture}[title/.style={font=\fontsize{8}{8}\color{black!50}\ttfamily}]
\node (a) at (0, 0) [rectangle, draw] {kernel};
\node (b) at (0, 1) [rectangle, draw] {\texttt{init}};
\node (c) at (0, 2) [rectangle, draw] {zygote};
\node (d) at (4, 2) [rectangle, draw] {DalvikVM};

\draw [->] (a) -- (b) node [midway] {};
\draw [->] (b) -- (c) node [midway] {};
\draw [->] (c) -- (d) node [midway] {};
\end{tikzpicture}

\includegraphics[width=\textwidth]{graphics/androidrt}

\subsubsection*{Android security objectives}
The goals are to protect user data, protect system resources (+network), and provide application isolation. 

\begin{shaded}
\textbf{Key Android security features:}
\begin{itemize}
	\item Robust security at OS level through Linux kernel
	\item Mandatory app sandboxing for all applications
	\item Secure IPC
	\item Application signing
	\item Application-defined and user-granted permissions
\end{itemize}	
\end{shaded}

\subsection{Android application model}
The Android application package (APK) consists of the following components:
\begin{itemize}
	\item \textbf{\texttt{classes.dex}.} Dalvik executable of Android app components
	\item \textbf{Resources and assets.} Images, string values, raw data, layouts, etc.
	\item \textbf{Native code.} C/C++ shared libraries linked dynamically
	\item \textbf{META-INF.} Certificate and signature information
	\item \textbf{Application manifest.} XML file that declares app metadata/components (names, intent filters, permissions). Its main elements are package info, app info (icon, etc.), activity component, etc.
\end{itemize}

Android requires that all apps be digitally signed with a certificate. Android apps used self-signed certificates. This certificate is used to identify the developer of an app. Android follows the \textbf{same-origin policy}. Android uses the same signing key-pair to ensure that updates come from the same developer.\\

An Android app is a combination of loosely coupled components. Each component can offer multiple entry points.
\begin{itemize}
	\item Activity: user interface
	\item Service: background services
	\item Content provider: database
	\item Broadcast receiver: mailbox for broadcasted messages
\end{itemize}

\subsubsection*{Intents}
\textbf{Intents} are named events and represent the \textit{intent} to do something, such as launching an activity, starting service, or broadcasting a message. Its payload and attributes describe the intended action. It can be sent/received by an app.\\

An \textbf{explicit} intent sets the target component name, such as \texttt{com.example.app.MainActivity}.\\

An \textbf{implicit} intent provides information including action, data, and type. This is resolved at runtime by the package manager. The Android framework will find a suitable receiver for this intent. For example: \texttt{Action=intent.ACTION\_VIEW; Data=www.youtube.com} will open an app that can show YouTube, such as the YouTube app or the default web browser.

\subsubsection*{Activity}
\begin{wrapfigure}{r}{0.5\textwidth}
\includegraphics[width=0.5\textwidth]{graphics/activity_lifecycle}
\end{wrapfigure} 
An \textbf{activity} is a main building block of GUI applications. It is like a website; multiple activities represent multiple ``pages'', and the main activity is like the homepage. It is possible to move from an activity to another, just like navigating through pages.\\

There are system calls as state changes due to user actions. If there is another activity started, the on-going activity is paused. App process may be killed, and a stopped activity can be destroyed.\\

The \textbf{Activity Manager} is responsible for creating, destroying, and managing activities. When a user starts an application for the first time, the AM will create its activity and put it onto the screen. When the user switches screens, the AM will move the previous activity to a holding place, so if the user wants to go back to an older activity it can be started more quickly.\\

Older activities that haven't been used for a while will be destroyed to free space for current ones.

\subsubsection*{Service}
A \textbf{service} is a background process without a user interface, used to perform some long-running operation, such as downloading files or playing music. It can be local to the app or provided by other apps. Services can define a remote interface using the Android Interface Definition Language. The AIDL compiler creates skeleton for implementation of the service (stub). Services are started and stopped on demand.\\

App components start unbounded services. A \textbf{bounded service} acts as a server. The app component (client) logs in (binds) to the server, consumes the services, and then unbinds.\\

Use an \textbf{unbounded service} to do work if the app components don't need interaction with the service again. Use a \textbf{bounded service} if interaction is required.


\subsubsection*{Content providers}
\textbf{Content providers} are interfaces for sharing data between apps. The interfaces are simple: \texttt{select(), insert(), update(),} and \texttt{delete()}. They must be declared in the manifest with the \texttt{<provider>} tag.\\

Content providers are accessed by the URI \texttt{content://<authority>/<resource>}.\\

\paragraph{Contacts} Content provider that exposes user contact data to applications. The contacts app uses the contacts provider (a separate app) to retrieve contacts data. The contacts app does not have contacts data.

\paragraph{Settings} Exposes system settings to applications, including to Settings.

\paragraph{Media} Store responsible for storing/sharing media across applications.

\subsubsection*{Broadcast receiver}
A \textbf{broadcast receiver} is a component that responds to system-wide events. It's a mailbox for broadcast intent messages. Intent filters can be defined to indicate what messages to receive.\\

Events can come from the system (SMS, low battery), or an application (data update complete).\\

Broadcast receivers are Android's implementation of a system-wide publish/subscribe mechanism. The system or apps are publishers, and user apps are subscribers. A subscribing app can subscribe by indicating intent filters in the manifest or registering dynamically. The receiver will receive a triggered event if there is a subscription.\\

Events are broadcasted to a number of receivers who subscribe for the event.\\

A BR has to register with the Activity Manager and the Package Manager. This can be done through the manifest or programmatically\footnote{I highly doubt code details are examinable...}.
\begin{shaded}
\begin{lstlisting}
<receiver android:name=``MsgListener''>
   <intent-filter>
      <action android:name=``compsci702.intent.action.BROADCAST''/>
   </intent-filter>
</receiver>
\end{lstlisting}

The \texttt{MsgListener} class is responsible for processing the intent. The \texttt{<action>} tag specifies the intents to be received.\\

To do it programmatically, add an intent with \texttt{IntentFilter\#addAction()} and override \texttt{onReceive(Context c, Intent i)} for the action to be performed, then register the receiver and filter.

\end{shaded}
\begin{figure}[h]
\centering
\caption{Android build process}
\includegraphics[width=0.5\textwidth]{graphics/build-apk}
\end{figure}

\subsection{Android ICC}
\subsubsection*{Android Binder}
Binder enables \textbf{inter-component communication} (ICC) in Android. It is implemented as a Linux kernel driver, as a customized version of Open Binder. It provides a simple RPC-like mechanism. Apps use Java methods to invoke ICC, then Android translates this into C++ invocations and system calls to the binder driver.\\

In Linux, processes communicate and share data through pipes, shared memory, and message queues. In Android, app components communicate through binder.\\


The \textbf{Activity Manager} is a service that apps use for ICC. It provides over 100 methods, including these common ones: \texttt{startActivity()}, \texttt{startBroadcast()}, \texttt{startService()}, and \texttt{bindService()}. Apps export services by publishing them through the Activity Manager.\\

The \textbf{Service Manager} is a special system service to keep track of available services. An app that wants to provide a service to others can publish its service through the Service Manager. Communication to the Service manager takes place through the Binder.\\

The Service Manager accepts these commands:
\begin{itemize}
	\item \textbf{Publish.} Used to publish a service within the Service Manager. Takes arguments: service name and address.
	\item \textbf{Get/check.} Returns an address of the service in form of handler. Takes argument: service name.
	\item \textbf{List.} Lists the service names registered with the Service Manager.
\end{itemize}

The Android middleware contains a \textbf{reference monitor} that mediates the establishment of ICC. This is part of the Activity Manager.

\subsubsection*{MAC security enforcement}
A reference monitor enforces MAC for regulating access to app components. Access to each component is restricted by assigning it an access permission label. Applications are assigned collections of permission labels. When a component initiates ICC, the reference monitor checks if its permission label is same as the target component's access permission label.\\

The Android middleware implements a reference monitor providing MAC enforcement about how apps access components.

\begin{figure}[h!]
\centering
\caption{A's ability to access B and C is determined by comparing the access permission labels on B and C with the collection of labels assigned to App 1.}
\includegraphics[width=0.9\textwidth]{graphics/plabels}
\end{figure}

Assigning permission labels to an app specifies its protection domain. Android's policy enforcement is mandatory: permission labels can't be changed until the app is reinstalled. This model restricts access to components and doesn't provide information flow guarantees.

\subsection{Sandboxing}
\textbf{Sandboxing} specifies which system resources an application is allowed to access. This limits malicious apps to perform actions only in the sandboxed environment. \\

There are two levels of sandboxing:
\begin{itemize}
	\item \textbf{Process level.} Each application is run in a dedicated process and access to sensitive resources depends on permissions. \begin{itemize} 
	\item Android assigns a unique User ID (UID) to each Android app.
	\item A UID (AppID) is generated at install time.
	\item It runs each app as a separate process with its UID.
	\item Apps run within the sandboxing environment in the kernel.
	\end{itemize}
	\item \textbf{Filesystem level.} Each application has its own private data directory and only the application can access its own data directory. \begin{itemize} 
	\item Each app is assigned a dedicated data directory.
	\item This applies to all apps (even native apps).
	\item Only the app has permission to read/write to its data directory.
	\end{itemize}
\end{itemize}

The app data directory is implemented based on Linux DAC. Permissions are set by the system \texttt{rwxrwxrwx}. Only the owner/root can change permissions.\\

System daemons and apps run under well-defined/constant UIDs. The root has UID 0. System UIDs are statically defined in the \texttt{android\_filesystem\_config.h} header file.\\

UIDs for system services start from 1000:
\begin{itemize}
	\item \texttt{android.uid.phone} (PHONE\_UID, 1001)
	\item \texttt{android.uid.bluetooth} (BLUETOOTH\_UID, 1002)
	\item \texttt{android.uid.log} (LOG\_UID, 1007)
	\item \texttt{android.uid.nfc} (NFC\_UID, 1027)
\end{itemize}

Apps can be installed using the same UID. Apps can share files and run in the same process. Shared UIDs are used by system apps which use the same set of resources. (Example: in Android 4.4, the system UI and keyguard share the same UID).\\

Shared UIDs aren't recommended for non-system apps, but is still available as long as the apps are signed with the same signing key.

\subsection{Permissions}
Apps are sandboxed, so they can only access their own files. Android can grant additional access rights (permissions) to apps. This helps Android control access to resources.\\

Apps request permissions defined in \texttt{AndroidManifest.xml}. Apps can request a set of additional permissions granted at runtime. A user may be asked to grant requested permissions. Android comes with a built-in list of pre-defined permissions. When new features come out, associated permissions are added as well. \textbf{Custom permissions} can be defined by system and user-installed apps.\\

An app that wants to receive incoming SMS (\texttt{RECEIVE\_SMS}) has to declare:

\begin{lstlisting}
<uses-permission android:name="android.permission.RECEIVE_SMS"/>
\end{lstlisting}

\subsubsection*{Permission management}
Permissions are assigned to each app by the package manager, which maintains a central database of installed packages with info about install path, version, certificate info, assigned permissions to each package, and a list of all permissions defined on a device. This database is in \texttt{/data/system/package.xml} and is updated every time an app is installed, updated, or uninstalled.

\subsubsection*{Permission protection levels}
The levels characterize potential risk in the permission and indicate the procedure that the system should follow when determining whether to grant the permission.

\begin{itemize}
	\item \textbf{Normal.} This is not security critical and is granted without asking users. \begin{itemize} \item\texttt{ACCESS\_NETWORK\_STATE} allows apps to access network information.\end{itemize}
	\item \textbf{Dangerous.} Grants access to user data or some control over the device. Involves functionalities that can cost money, so requires user approval. \begin{itemize}
	\item \texttt{READ\_SMS} allows apps to read SMS.
	\item \texttt{CAMERA} gives apps access to camera.
	 \end{itemize}
	 \item \textbf{Signature.} Only granted to requested apps that are signed with the same key as the app that declared the permission. Strongest permission level as it requires cryptographic key possession. Apps using these permissions are controlled by the same developer. Decided by system without requiring user intervention. Typically used by system apps that do device management.
	\begin{itemize}	 \item \texttt{NET\_ADMIN} allows configuration of network interfaces, IPSec, etc.
	\end{itemize}
	\item \textbf{SignatureOrSystem.} Granted to apps part of the system image or signed with the same key as the app that declared permission. Allows vendors to have pre-installed apps to share specific features that require a permission without having to share signing keys. Until Android 4.3, any app installed in the system partition was granted this permission. Since Android 4.4, apps need to be installed in \texttt{system/priv-app} to get this.
\end{itemize}

\textit{TODO: The diagrams on these slides...}

\subsection{Security refinements}
Android's security framework is based on MAC and DAC. It offers additional refinements as well which are exceptions.

\subsubsection*{Public and private components}
Private components simplify security specification as devs don't have to worry about permission labels. By default, components are public (but declare them as private for best practice).\\

Apps may contain components that others should never access, such as a password. Developers can declare this component private (in manifest file, set exported attribute to false). Private components can only be accessed by other components in the same app.\\

\subsubsection*{Implicitly open components}
Developers frequently define intent filters on activities. For example, the system may find an image viewer when an intent has a \texttt{VIEW} action. The caller won't know beforehand what access permission is required. The developer of the target activity can declare it open by not assigning access permission to it (public without permissions).\\

This default policy specification enables functionality and ease of development. However, any app can have access and can lead to poor security practices.\\

Best practices:
\begin{itemize}
	\item Components must be declared open in exceptional cases.
	\item Consider splitting components to sub-components to specific fine-grained control.
\end{itemize}

\subsubsection*{Broadcast intent permissions}
A broadcast intent is read by all apps so can lead to the leaking of sensitive information. With a broadcast intent permission, the developer can protect the intent. This is declared programmatically with \texttt{sendBroadcast(intent, PERMISSION)}.

\subsubsection*{Content provider permissions}
Always define both read and write permissions for content providers, which provide interfaces for reading and writing.

\subsubsection*{Service hooks}
If a component has the permission, it can start, stop, or bind the service at any time. To specify more flexible and fine-grained access control, Android lets components invoke the \texttt{checkPermission()} method. This is done at the code level.

\subsubsection*{Pending intents}
Pending intents delegate actions to another application. This allows other apps to invoke services on behalf of the requesting app. This allows better integration with third party apps, but since it enables delegation, it deviates from MAC.

\subsubsection*{URI permissions}
Android uses a special content URI to deal with content providers, and can specify a record within a table. An app that doesn't have a read permission to access the content provider can get access with a URI permission. The developer can pass a URI in an intent filter. This also deviates from MAC.

\subsection{Security weaknesses}
Poorly designed apps can result in resources being exposed or depleted, as well as the loss of privacy.

\subsubsection*{Privilege escalation}
An adversary tries to escalate privileges to gain unauthorized access to protected resource.\\

\paragraph{Confused deputy attack} If an app doesn't have a permission, it can ask its neighbor. This leverages the vulnerability in a benign app.
\paragraph{Collusion attack} Multiple apps can collaborate to get permissions which each of them cannot get otherwise. For example, if an app has access to location, and another has access to the internet, they can collude to expose user information on the internet.\\

Android supports all-or-nothing access and doesn't offer fine-grained access control. If an app has access to the internet and contacts, the app can use contacts and use the internet. It is not okay for the app to publish contacts through the internet. \textit{Information flow techniques needed to prevent information disclosure.}

\subsection{Runtime permissions in Android 6}
Android 6.0 Marshmallow was released in October 2015 (API level 23). In this version and onwards, users grant permissions at runtime rather than at install-time. This streamlined the app installation process and also gives user more control over the app's functionality. A user can give a camera app access to the camera but not the location.\\

Users can revoke permissions at any time in the Settings app.\\

From a user's perspective, permissions can be categorized in to normal or dangerous. Normal permissions are automatically granted as they don't risk privacy. Dangerous permissions have to be approved as they can give the app access to confidential data.\\

Prior to Android 6, users had to grant dangerous permissions when they install the app as the app won't be installed if the user doesn't grant permissions. Now, the app lists all the permissions in its manifest, and must request each dangerous permission it needs while the app is running. Users can grant/deny each permission; the app will still run (with limited capabilities).\\

Permissions must be checked each time an operation that requires the permission is called by calling the \texttt{checkSelfPermission()} method. This returns \texttt{PackageManager.PERMISSION\_GRANTED} if the app has the permission, or \texttt{PackageManager.PERMISSION\_DENIED} if it doesn't, at which point the app has to ask the user for permission.\\

With Android, explanations for permissions can be added so that the user can know why a certain permission is required.\\

When an app requests permissions, the system presents a dialog box to the user; the app cannot change the dialog box. When the user responds, the system invokes \texttt{onRequestPermissionsResult()}. The app must override that method to determine if the permission was granted.\\

There are two ways for an app to perform a task: by asking the permission, or use an intent to get another app to perform the task. With permissions, the app has full control over the UX, but this adds complexity to the task. With the use of intents, the app that handles the intent provides the UI and thus the app has no control over the UX.

\subsection{App distribution}
The Google Play Store is Google's app distribution platform and official Android app store. To distribute apps, developers have to pay a registration fee for a Google Play Developer Console account. Developers receive 70\% of the app's price. Only Android devices that comply with Google's compatibility requirements may install and access apps.\\

\textbf{Malware} is software that can disrupt normal activities, such as compromising privacy, reliability, confidentiality, etc. 99\% of mobile malware is on Android.

\paragraph{Spyware} Collect sensitive information and upload to remote servers. Example: FakeNetflix collects Netflix credentials.
\paragraph{Destructive trojans} Modify content on devices. Example: Android.Elite.1.origin is a fake Angry Birds game.
\paragraph{Financial charges} SMS trojan for sending SMS to premium numbers. Example: FakePlayer sends a hard-coded message to premium numbers in Russia.
\paragraph{Ransomware} Steal data or disables phone functionality and asks for money to unlock this data.
\paragraph{Mobile botnets} Receive commands from remote command and control servers.
\paragraph{Root-kit exploits} Lots of stuff.

\subsubsection*{Google Bouncer}
Google Bouncer is an in-house anti-malware system by Google as a first line of defense against Android malware. It emulates Android apps on Google's cloud and looks for anomalies that may be indicative of malware. Full coverage but less reliable.

\paragraph{Static analysis} Analysis that does not require code execution. A static analysis tool inspects programs for possible runtime behaviors to find potentially malicious code.
\paragraph{Dynamic analysis} Requires code execution to determine program flow. Reliable but lacks coverage.

In 2015, a Google announcement announced that the app review process will involve a team of experts.

\subsection{Google Bouncer}
Google Bouncer was easily bypassed. This section discusses how that happened.\\

It was discovered that it was possible to submit apps without paying. Submit a sample app that connects to a command and control server, but do no harm. Bouncer ran the app before it was published.\\

Bouncer did runtime analysis of app in an emulated Android environment for 5 minutes on Google's infrastructure. It allowed external network access.\\

It was possible to fingerprint the QEMU version and get information. The Android ID returned was indicative of an emulator, but recent tests indicate that the ID is now dynamic. The account owner was associated with \texttt{miles.karlson@gmail.com}.\\

In short, Bouncer runs your app for 5 minutes so if you don't do anything bad for 5 minutes it's fine. Bouncer is not a physical device. It explores the app by emulating input and clicking. If your app is flagged, then a human analyzes the app.

\subsection{App installation and scanning}
\textbf{App repackaging} is a major attack vector. Attackers can't forge signatures but can remove the original signature and re-sign the repackaged app with a new certificate. This new app encloses a malicious payload. Android prevents malicious updates but breaks trust on the first time install.\\

Android apps can be installed from the Play Store or via \textbf{sideloading}, or installing apps from other sources. The latter requires enabling installation from \textit{unknown sources} in security settings.\\

Sideloading can take place through USB (e.g. \texttt{adb install app.apk}), Bluetooth, Wi-Fi, third party app stores, or downloads.\\

Google Play offers security services:
\paragraph{Protection within Google Play Store} Play Store has policies in place to protect users from attackers. Developers are reviewed when they create their developer account based on profile and credit cards. They are also reviewed upon app submissions. Google Play also scans apps for malware and other vulnerabilities, and suspends accounts that violate policies.
\paragraph{App review} Ratings and reviews provide information about an app. Apps that mislead users may have low reviews. (What about paid reviews and all that?)
\paragraph{Remote app removal} Google can remove malicious apps the store. If an installed app poses a threat, Google can remotely remove it.
\paragraph{Google Play Protect} This is an additional service that provides protection from apps outside of Google Play. This scans apps when you install them and scans for potentially harmful apps. By default, app verification is enabled but can be disabled. (Can it identify obfuscated harmful apps?)

\subsection{Android for Work}
\textbf{TrustZone} supports a full Trusted Executed Environment (TEE) and runs in a special CPU mode called Secure Mode. Memory for secure mode and security functions are hidden from the ``normal world." Android vendors can supply security features such as secure boot or DRM with this.\\

Cryptography is used throughout Android to ensure confidentiality and integrity. Applications of it include: device encryption, app signing, and network connectivity/encryption.

\subsubsection*{Device encryption}
Process of encoding user data on an Android device with an encryption key. If device encryption enabled, all user-created data automatically encrypted before storing on disk. All reads automatically decrypt data before returning to calling process. Android disk encryption based on \texttt{dm-crypt}. Android uses AAES for device encryption\\

Application security include: sandboxing, permissions, SELinux, app signing, Google Play reviews and Play Protect.\\

\subsubsection*{Network security}
Android provides secure communications over the Internet by supporting TLS/SSL. Their security team developed a tool called \texttt{nogotofail} which confirms if devices/apps are safe against known vulnerabilities/misconfigurations.\\

\subsubsection*{BYOD}
Android 5 and onwards support enterprise use cases.\\

BYOD refers to the policy of allowing employees to bring their own devices to the workplace. They are used to gain privileged corporate information/apps.\\

A primary user is the first user added to a device. They can't be removed unless it's by a factory reset. This user also has special privileges and is always running. Secondary users can be added and removed by the primary user.\\

A \textbf{work profile} is a separate Android user managed by the enterprise. The \textbf{profile owner} can manage the corporate space on a user's personal device. The \textbf{device owner} is like a profile owner but to the device; it is the device admin in the corporate use case.

\subsubsection*{Application management}
\textbf{Google Play for Work} offers APIs used by enterprise mobility management (EMM) vendors to allow them to manage apps. IT admins can remotely install/remove apps on a managed Android for Work device. They can define which users can see which apps, and can see which users have which apps installed.\\

Apps can be published by an enterprise customer and targeted privately. There are two modes of delivery: Google-hosted or externally-hosted. Apps must comply with Google Play policies.\\

An app can allow IT admins to remotely control the availability of features or configure settings.
\newpage
\section{iOS Security}
\subsection{Overview}
\begin{itemize}
    \item Always with us - Likely to be lost or stolen
    \item Always on - Continuous target
    \item Change networks repeatedly - Greater change of MitM attacks
    \item Password protection - less likely to use long passwords\\
\end{itemize}

Smartphones are subject to almost all of the standard security attacks
\begin{itemize}
    \item Malicious websites
    \item Trojan horses
    \item Buffer overflow attacks
    \item Social engineering\\
\end{itemize}

We are trying to protect
\begin{itemize}
    \item Data on the device
    \item Data sent or received by the device
    \item Our applications
    \item OS
\end{itemize}

\subsection{Introduction to iOS Security}
\subsubsection{OS 1.0 (2007)}
\begin{itemize}
    \item Very \textbf{little} in terms of security
    \begin{itemize}
        \item No privilege separation
        \item No code signing
        \item No Data Execution Prevention
        \item No Address Space Layout Randomisation
        \item No sandboxing
    \end{itemize}
\end{itemize}

\subsubsection{iOS 1.0}
\begin{itemize}
    \item There was an attempt to \textbf{reduce the attack surface}
    \item No support of flash or shell
    \item \textbf{Limited file formats}
    \begin{itemize}
        \item MobileSafari cannot deal with all formats acceptable to Safari
        \item PDF viewer only parses some features - PDF rendering has still been used in many exploits
    \end{itemize}
\end{itemize}

\subsubsection{iOS 2-11}
Security was taken much more seriously
\subsubsection*{Passcodes}
\begin{itemize}
    \item Passcode, Touch ID, Face ID
    \item Springboard \textbf{slows down} after repeated attempts
    \item Users can set the device to erase data after 10 attempts
    \item Delays between passcode attempts
    \item Restriction passcode - different from device passcode, for controlling access to apps
    \item App privileges - user is asked when apps first attempt to use 'private' information
\end{itemize}

\subsubsection*{Preventing Phone Theft}
\begin{itemize}
    \item Mobile phone theft is a major problem
    \item Cannot erase device without password
    \item Find My iPhone
    \begin{itemize}
        \item Lock device
        \item Device tracking
        \item Erase data - done by deleting the file system encryption key
        \item Activation Lock - cannot turn off any features without the ID and password
    \end{itemize}
    \item Kill switch - Apple can disable or delete an app on your device
    \item Cannot restore backup without the password
\end{itemize}

\subsection{iOS Device and App Trust Evaluation}
\subsubsection{Code Signing}
\begin{itemize}
    \item Mandatory
    \item Only apps signed by Apple are installed
    \item Device checks certificate and signature before running the app
    \item App code and memory continually checked as it runs
\end{itemize}

\subsubsection*{Verifying Signing}
\begin{itemize}
    \item Verify the signer, and the integrity of the App (code)
    \item When an executable is loaded, the signature is loaded and checked in kernel. If it is \textbf{not} in the static trust cache, a function is called to check the signature
    \item Apps that come with the device do not have a signature, the binaries hash is stored in the iOS kernel in the static trust cache
\end{itemize}

\subsubsection*{Digital Signatures}
\begin{itemize}
    \item Public key cryptography - signer encrypts using \textbf{private key}
    \item Hashing - app digest
\end{itemize}

\begin{figure}[h]
\centering
\caption{Verifying integrity of an application}
\includegraphics[width=0.5\textwidth]{graphics/applesignature}
\end{figure}

The App Developer sends the App to Apple who review and sign the application. The signature comprises of \textbf{encrypting the hash} of the app with Apple's \textbf{private key}. To verify the App, decrypt the signature using Apple's \textbf{public key} and compare the decrypted hash with the hash of the app.

\subsubsection{iOS App Testing}
\textbf{Problem:} If signing is always required, how can app developers test or debug newly developed apps?

\subsubsection*{Apple Provided Certificates}
Certify that \textit{Alice} holds the private key of the public key to be used by \textit{Bob's} iPhone.
\begin{itemize}
    \item App development - \textbf{developer certificate}
    \item App distribution - \textbf{distribution certificate}
\end{itemize}

\begin{shaded}
Certificate = Public Key(Message) + Apple's Digital Signature
\end{shaded}

\subsubsection{Provisioning Profiles}
A provisioning profile is required for an app that is being developed to be installed on a certain device. Configures the device to allow the execution of signed code. Installed on a device \textbf{only} if the device ID is in the profile.\newline

Provisioning profiles consist of:
\begin{itemize}
    \item An XML property list
    \begin{itemize}
        \item App ID - random characters followed by the company ID and app name
        \item Which \textbf{devices} - Each device has a unique device id (UDID)
        \item Developer certificate
        \item Entitlements
    \end{itemize}
\end{itemize}

Validating a Provisioning Profile
\begin{itemize}
    \item The signing certificate is signed by Apple - called Apple iPhone OS Provisioning Profile Signing
    \item Certificate signing chain is no longer than three links
    \begin{itemize}
        \item \textbf{Development} - Developer, Apple Root CA
        \item \textbf{Deployment on App Store} - Apple iPhone OS Application Signing, Apple Root CA
    \end{itemize}
\end{itemize}

\subsubsection*{Apple Developer Program Team Roles}
\begin{itemize}
    \item Team Agent
    \begin{itemize}
        \item Legally responsible for the team
        \item Acts as the initial primary contact with Apple
        \item Can invite team members and change the access level of any other team member
        \item There is only one team agent
    \end{itemize}
    \item Team Admin
    \begin{itemize}
        \item Can set the privilege levels of other team members (except the team agent)
        \item Manages all assets used to sign your apps (either during development or when your team is ready to distribute an app)
    \end{itemize}
    \item Team Member
    \begin{itemize}
        \item Can create development certificates
        \item Register a device connected to their Mac
        \item Create a development provisioning profile using Xcode
        \item Cannot register devices
    \end{itemize}
\end{itemize}

\begin{table}[h]
\centering
\caption{Apple Developer Program Roles and Privileges}
\begin{tabular}{|l|l|l|l|}
\hline
\textbf{Privilege}                       & \textbf{Team Agent} & \textbf{Team Admin} & \textbf{Team Member} \\ \hline
Accept legal agreements                  & \checkmark                   & x                   & x                    \\ \hline
Renew membership                         & \checkmark                   & x                   & x                    \\ \hline
Create Developer ID certificates         & \checkmark                   & x                   & x                    \\ \hline
Invite members and assign roles          & \checkmark                   & \checkmark                   & x                    \\ \hline
Create distribution certificates         & \checkmark                   & \checkmark                   & x                    \\ \hline
Create development provisioning profiles & \checkmark                   & \checkmark                   & \checkmark                    \\ \hline
\end{tabular}
\end{table}

\newpage
\subsubsection*{Membership Types}
\begin{table}[h!]
\centering
\caption{Membership Benefits}
\begin{tabular}{|l|l|l|l|l|}
\hline
\textbf{Resources}        & \textbf{Apple ID} & \textbf{Individual}       & \textbf{Organisation}     & \textbf{Enterprise Program} \\ \hline
Xcode Developer Tools     & \checkmark      & \checkmark & \checkmark & \checkmark   \\ \hline
Test on Device            & \checkmark      & \checkmark & \checkmark & \checkmark   \\ \hline
App Store Distribution    &                                & \checkmark & \checkmark &                             \\ \hline
In-house App Distribution &                                &                           &                           & \checkmark   \\ \hline
Team Management           &                                &                           & \checkmark & \checkmark   \\ \hline
App Analytics             &                                & \checkmark & \checkmark &                             \\ \hline
Cost                      & Free                           & 99 USD                    & 99 USD                    & 299 USD                     \\ \hline
\end{tabular}
\end{table}

\subsubsection*{Entitlements}
\begin{itemize}
    \item Policies regarding what an app can do (e.g. debugging)
    \item Apple can add entitlements to limit functionality
    \item Stored in a property list
\end{itemize}

\begin{figure}[h]
\centering
\caption{iOS App Development}
\includegraphics[width=0.75\textwidth]{graphics/iosAppDevelopmentProvisioningProfiles}
\end{figure}

\subsubsection{App Store Deployment}
\begin{itemize}
    \item Apple certifies and signs the app bundle
    \begin{itemize}
        \item App ID
        \item No device information
        \item Trust is based on Apple's certificate
    \end{itemize}
    \item Because Appl checks the app before distribution, it acts like an antivirus program
\end{itemize}

\subsubsection*{Certificate Revocation}
Apple supports revocation through
\begin{itemize}
    \item Certificate Revocation List (CRL) - Server holds a list of revoked certificates
    \item Online Certificate Status Protocol (OCSP)
\end{itemize}

\subsubsection*{Sideloading in iOS}
\begin{itemize}
    \item Developers can release open-source apps outside of the App Store
    \item Interested users can compile and run it on their own devices
    \item A bit more complicated than Android because slideloading requires a physical connection and a Mac running Xcode
\end{itemize}

\subsection{Data Execution Prevention}
\subsubsection{Stack Overflow Attack}
Occurs when a program writes to a memory address on the program's call stack outside of the intended data structure, which is usually a fixed-length buffer. \newline

\begin{shaded}
\begin{lstlisting}
A()
{
    B(5);
    printf("done");
}

B(int a)
{
    char name[5];
    gets(name);
}
\end{lstlisting}
\end{shaded}

If the value of \texttt{name} is larger than 5 characters, it starts to corrupt the stack. If you pass in \begin{lstlisting}
<nop><malware><addrs of name[1]>
\end{lstlisting} you will overwrite the return address of A() to be the address of \textit{name[1]} which is the location of the inserted malware.

\begin{figure}[h]
\centering
\caption{Stack Overflow Attack}
\includegraphics[width=0.3\textwidth]{graphics/stack}
\end{figure}

\subsubsection*{How to prevent Stack/Buffer Overflow Attack?}
\begin{itemize}
    \item Do not allow writable pages to be executable
    \item Data Execution Prevention (DEP)
\end{itemize}

\subsubsection{Data Execution Prevention}
\begin{itemize}
    \item Executable pages are not writable
    \item Prevents code modification - uses the ARM NX bit on pages (never execute)
    \item Prevents dynamic production of code - except Mobile Safari JIT code
    \item All page requests and permission changes are checked
\end{itemize}

\subsubsection*{Bypassing DEP}
\begin{itemize}
    \item 'return-to-libc' exploits
    \item Point return address to system() in libc
    \item Call to system() not allowed in iOS
    \item Return Oriented Programming - inspired by 'return-to-libc'
\end{itemize}

\subsubsection*{Mobile Safari JIT}
\begin{itemize}
    \item DEP ruled out JIT compiling but is essential for making mobile Safari faster
    \item A compromise - mobile Safari (only) allowed to make writable and executable memory region
    \item Only one such memory region allowed
    \item The checks only made in kernel at runtime
    \item Shell code (malicious) can be written to JIT buffer area
\end{itemize}

\subsubsection{Return Oriented Programming}
\begin{itemize}
    \item Attacker gains control of call stack to hijack control flow, executes carefully chosen machine sequences that are already present in the machine's memory, called \textit{gadgets}
    \item Each gadget typically ends in a return instruction and is located in a subroutine within the existing program
    \item Gadgets are chained together to perform the actions
    \item ROP to disable DEP exists - ineffective in iOS due to code signing
    \item In iOS, ROP payload should contain the malware - difficult
    \item \textbf{Limitations} - For ROP to succeed, the memory map (addresses) of an App (in execution) need to be found (Executable code, Heap, Stack)
\end{itemize}

\subsection{Address Space Layout Randomisation (ASLR)}
\begin{itemize}
    \item Code signing and DEP not sufficient to withstand ROP
    \item Randomize the memory location (base address) of key program components
    \item Was originally designed to overcome "return-to-libc" attack
    \begin{itemize}
        \item Randomize libraries
        \item Partial ASLR
    \end{itemize}
    \item Works best if all code is compiled with the Position Independent Execution (PIE) flag
    \begin{itemize}
        \item Full ASLR
        \item Many third party apps are not compiled for PIE
    \end{itemize}
\end{itemize}

\begin{figure}[h]
\centering
\caption{ASLR}
\includegraphics[width=0.5\textwidth]{graphics/aslr}
\end{figure}

\begin{table}[h]
\centering
\caption{Partial vs Full ASLR - (R = Randomised)}
\begin{tabular}{|l|l|l|l|l|l|}
\hline
\textbf{PIE} & \textbf{Main Executable} & \textbf{Heap}   & \textbf{Stack}  & \textbf{Shared Libraries} & \textbf{Linker} \\ \hline
No           & Fixed                    & R per execution & Fixed           & R per device boot         & Fixed           \\ \hline
Yes          & R per execution          & R per execution & R per execution & R per device boot         & R per execution  \\ \hline
\end{tabular}
\end{table}

\subsubsection*{ASLR Based on Entropy}
\begin{itemize}
    \item Single non-randomised area can be enough for attacker
    \item The larger the range of entropy, the better (32bit vs 64 bit)
    \item Relocation frequency - randomisation during boot time vs execution time
\end{itemize}

\subsubsection*{Address Leakage}
\begin{itemize}
    \item Getting address information from an app
    \item Brute force can be effective
    \item Lots of exploits have been designed to leak addresses
    \item Even PIE is not enough, we really need every function scattered randomly through the address space - finding one address means we can easily determine others
\end{itemize}

\subsubsection*{ASLR in Different Mobile OS}
\begin{itemize}
    \item iOS
    \begin{itemize}
        \item Apple introduced ASLR in iOS 4.3
        \item Full ASLR support in iOS5 and later
    \end{itemize}
    \item Android
    \begin{itemize}
        \item Android 4.0 provides ASLR
        \item Full ASLR was supported in Android 4.1
        \item Android 5.0 dropped non-PIE support and requires all dynamically linked binaries to be position independent
    \end{itemize}
\end{itemize}

\subsection{Preventing Malicious Apps}
\begin{itemize}
    \item Prevent malicious apps at submission time - static and dynamic analysis
    \item Prevent malicious apps at install (or load) time - Code Signing Enforcement (CSE)
    \item OS also prevents malicious apps -  DEP and ASLR
\end{itemize}

\subsection{iOS Sandboxing}
\textbf{Sandboxing} is isolating app data and code execution from other app's \textit{so that if the app is compromised, it's effect on other apps is minimised}. Also allows for a set of fine-grained \textit{per-app-based access control} that restricts Apps access to resources.\\

\begin{itemize}
    \item Developer expresses what resource each app requires
    \item Based on the request, iOS allows/denis resources to the app
    \item Each app runs in its own container
    \item User controls access to documents
\end{itemize}

\textbf{Entitlements} are part of the provisioning profile. The developer mentions what specific resource the app requires. One of the entitlements is enabling app sandboxing, doing so removes all but a minimal set of privileges. Other required privileges are restored one-by-one using appropriate entitlements.

\subsubsection{App Container}
\begin{itemize}
    \item App's access to the file system is limited to container directories
    \begin{itemize}
        \item For iOS 8-9, container stored within \textit{var/mobile/Containers}
        \item iOS 10, container stored within \textit{/var/Containers}
    \end{itemize}
    \item Each container directory has a specific role
    \begin{itemize}
        \item Bundle: read-only, signed to prevent writing by user, contains the app and all its resources
        \item Data: various sub-directories to organise app's data
    \end{itemize}
\end{itemize}

\begin{table}[h]
\centering
\caption{What do Container Directories Store}
\begin{tabularx}{\textwidth}{|lX|lX|}
\hline
\textbf{Subdirectory}                 & \textbf{Description}                                                                                               \\ \hline
\textless{}AppName\textgreater{}.app/ & The signed bundle containing the application code and static data                                                  \\ \hline
Documents/                            & App-specific user-created data files that may be shared with the user's desktop                                    \\ \hline
Library/                              & Application support files                                                                                          \\ \hline
Library/Preferences/                  & Application-specific preferences files                                                                             \\ \hline
Library/Caches                        & App-specific data that should persist across successive launches of the application but not needed to be backed up \\ \hline
tmp/                                  & Temporary files that do not need to persist across successive launches of the application                          \\ \hline
\end{tabularx}
\end{table}

\subsubsection*{Accessing Outside Files}
\begin{itemize}
    \item To be specified using entitlements
    \item Programmatic access to standard location
    \begin{itemize}
        \item Downloads \textit{(com.apple.security.files.downloads.read-write)}
        \item Music \textit{(com.apple.security.assets.music.read-only / .read-write)}
    \end{itemize}
    \item User selected files (open, save, drag-drop, etc.)
\end{itemize}

\subsubsection*{Sharing Data Outside Sandbox}
\begin{itemize}
    \item Very limited channels
    \item Apps with the same \textit{ApplicationIdentifierPrefix}
    \begin{itemize}
        \item Which means the same developer
        \item Can share data through the keychain
    \end{itemize}
    \item Can also share data via servers
    \item And of course via the clipboard
\end{itemize}

\subsubsection{Sandbox Implementation}
\begin{itemize}
    \item Implemented as a policy module in TrustedBSD MACF
    \item The valid opersations of a process are constituted as policies - polices stored as a set of rules (aka profile)
    \item User space library functions to turn the profile to system calls for installing and configuring sandbox
    \item A kernel extension to evaluate policy restrictions
    \item A kernel extension to enforce individual policies
    \item A Mach server for handling logging from the kernel and holding prebuilt configurations
\end{itemize}

\subsubsection*{Profile}
\begin{itemize}
    \item A set of per-process conditional rules defining access to system calls
    \item Rules can require capabilities (entitlement, sandbox extension)
    \item Stored as \textit{compiled binary blobs}
    \begin{itemize}
        \item In \textit{sandboxd} for iOS 5-8
        \item In \textit{sandbox} kernel extension for iOS 2,4, $>$=9
        \item Until iOS 8, different blob for different sandbox profile
        \item For iOS $\geq$9, single binary blob
    \end{itemize}
    \item Written in Sandbox Profile Language(SBPL)
    \begin{itemize}
        \item Each rule consists of
        \begin{itemize}
            \item decision - deny
            \item operation - file-read*
            \item filter - literal "/bin/a.txt"
        \end{itemize}
        \item SBPL code compiled to binary blob graphs
        \item built-in profiles for built-in apps
        \item "container sandbox profile" for all third-party apps
    \end{itemize}
    \item Filter - filter type (literal), filter value ("/bin/a.txt")
    \item Metafilter - logical operation of filters
    \begin{itemize}
        \item require-all (AND)
        \item require-any (OR)
        \item require-not (NOT)
        \item require-entitlement implies require-all
    \end{itemize}
\end{itemize}

\begin{figure}[h]
\centering
\caption{Profile Storage in iOS}
\includegraphics[width=0.5\textwidth]{graphics/profileblobs}
\end{figure}

\begin{figure}[h]
\centering
\caption{Sandbox Profile}
\includegraphics[width=0.75\textwidth]{graphics/profilestorage}
\end{figure}

\begin{figure}[h!]
\centering
\caption{Graph-like View for Operation Node Array}
\includegraphics[width=0.75\textwidth]{graphics/operationnodearray}
\end{figure}

\newpage
\subsubsection{How does Sandboxing work?}
\begin{itemize}
    \item Once a sandbox is initialised, function calls are hooked by TrustedBSD and pass through Sandbox.kext (for policy enforcement)
    \item Sandbox.kext consults the list of rules for the current process
    \item For rules requiring pattern matching support, functions from AppleMatch.kext are imported for performing regular expression matching
    \item \textit{sandbox} is used to carry tracing and logging information and request for prebuilt profiles
\end{itemize}

\subsection{iOS Encryption}
\subsubsection*{Hardware Support for Encryption}
\begin{itemize}
    \item Dedicated AES-256 crypto engine - Built into the DMA path between flash storage and main memory
    \item Two keys: UID (device unique id) and GID (device group id) fused/compiled to the chip
    \item Random number generator for creating other keys
    \item Secure enclave for managing keys
    \begin{itemize}
        \item Virtual secure coprocessor
        \item Communication with application processor using interrupt-driven mailbox and shared memory data buffers
    \end{itemize}
    \item Effaceable storage to securely erase keys
    \begin{itemize}
        \item Flash drive employs wear-leveling due to which multiple copies of data need to be deleted
        \item Multiple copies are created when data erased frequently
        \item Block 0 of the NAND as the effaceable storage - can be addressed directly and erased surely
    \end{itemize}
\end{itemize}

\subsubsection{Attempt 1: Encryption Using Passcode}
\begin{itemize}
    \item Encrypt (AES 256) each file using a passcode (key)
    \item Main Issues
    \begin{itemize}
        \item Brute-forcing
        \item Changing a passcode will require re-encryption of file content using a new passcode
    \end{itemize}
\end{itemize}

\textbf{Hardening Brute Forcing} can be done by stretching passcodes using a Key Derivation Function (KDF). Derive a secret key from the passcode generating a passcode key.
\begin{shaded}
651426 (passcode) -$>$ KDF -$>$ No9u5Z41+\&m\#4!T01 (passcode key)
\end{shaded}

\subsubsection{Attempt 2: Encryption Using Passcode Key}
\begin{itemize}
    \item Encrypt each file using the passcode key
    \item Main Issues
    \begin{itemize}
        \item Changing the passcode will require re-encryption of file contents using the new passcode key
    \end{itemize}
\end{itemize}

\subsubsection{Attempt 3: Layered Encryption}
\begin{itemize}
    \item Encrypt each file using a file key
    \item Encrypt (warp) each file key using the passcode key
    \item Changing a passcode will just require re-encryption of the file key using the new passcode key
\end{itemize}

\begin{figure}[h]
\centering
\caption{Layered Encryption}
\includegraphics[width=0.5\textwidth]{graphics/layeredencryption}
\end{figure}

\subsubsection{Supporting Access Control}
\begin{itemize}
    \item File can be accessed when device is unlocked
    \item File can be accessed anytime
    \item File protection classes: via key hierarchy
\end{itemize}

\begin{figure}[h]
\centering
\caption{File Protection Classes}
\includegraphics[width=0.75\textwidth]{graphics/fileprotectionclasses}
\end{figure}

\subsubsection*{Class Key}
\begin{itemize}
    \item Different class keys represent circumstances under which files should be accessed
    \item A file key is encrypted using a class key
    \item \textbf{Hardware key} and passcode key are used to protect class keys
\end{itemize}

\begin{figure}[h]
\centering
\caption{Class Key}
\includegraphics[width=0.75\textwidth]{graphics/classkey}
\end{figure}

\subsubsection*{Keybags}
\begin{itemize}
    \item Keys for both file and keychain \textbf{data protection classes} are collected and managed in keybags
    \item iOS uses four different keybags
    \begin{itemize}
        \item System keybag
        \item Backup keybag
        \item Escrow keybag
        \item iCloud backup keybag\\
    \end{itemize}
\end{itemize}

UID key is unique to the device
\begin{itemize}
    \item An AES 256-bit hardware key
    \item Inside secure enclave
    \item Cannot access it through software
    \item This encrypts a static string to produce the \textbf{hardware key}
    \item Neither recorded by Apple nor by any of its suppliers
\end{itemize}

\begin{figure}[h]
\centering
\caption{Key Hierarchy for Different Class}
\includegraphics[width=0.75\textwidth]{graphics/keyhierarchy}
\end{figure}

\newpage
\subsubsection*{Complete Unless Open}
\begin{figure}[h]
\centering
\caption{Creating the File}
\includegraphics[width=0.75\textwidth]{graphics/creatingthefile}
\end{figure}

\begin{figure}[h]
\centering
\caption{Reading the File}
\includegraphics[width=0.75\textwidth]{graphics/readingthefile}
\end{figure}

\subsubsection*{File System Key}
\begin{itemize}
    \item File system key encrypts file metadata
    \begin{itemize}
        \item Created when iOS is installed or the device is wiped by the user
        \item Encrypted by the hardware key
    \end{itemize}
    \item Encrypted file system key again encrypted by the effaceable key - for quick eraser
\end{itemize}

\begin{figure}[h]
\centering
\caption{File System Key}
\includegraphics[width=0.5\textwidth]{graphics/filesystemkey}
\end{figure}

\newpage
\subsubsection*{Key Hierarchy}
\begin{figure}[h]
\centering
\includegraphics[width=0.75\textwidth]{graphics/keyhierarchy_2}
\end{figure}

\subsubsection*{Why Layered Keys}
\begin{itemize}
    \item The entire filesystem can be rendered useless by wiping the file system key
    \item Modifying a passcode just rewraps the class key
    \item Changing a file's class only requires rewrapping of the file key
    \item If the device key is used, files or keychain items could only be restored using the same device
\end{itemize}

\subsubsection*{Key Chain Protection}
\begin{itemize}
    \item A secure container to store short but sensitive data: password, key, login token
    \item Encrypted using 256-bit AES
    \item \textit{securityd} daemon determines which Keychain items each app can access
    \item Uses access control lists (ACLs) to set policies for accessibility and authentication requirements
    \item Keychain items can be shared between apps of the same developer
    \item A class structure is used for protection
\end{itemize}

\newpage
\subsubsection*{Keychain Item Protection Classes}
\begin{figure}[h]
\centering
\includegraphics[width=0.75\textwidth]{graphics/keychainitemprotectionclasses}
\end{figure}

\subsection{iOS Privacy}
\begin{itemize}
    \item Only you can access your device
    \item Your personal data belongs to you
    \begin{itemize}
        \item Apple does not sell your data to third-parties (except they do)
        \item Apple does not track what you shop (they probably do this as well)
    \end{itemize}
    \item Your experience improves while your data stays private
    \item Differential privacy - scramble data and mix it with other users so that the general pattern can be known but not specifics
    \item Apple does not want to know
    \begin{itemize}
        \item Which emoji you are using the most
        \item Which new word you introduced
    \end{itemize}
    \item Apple wants to know
    \begin{itemize}
        \item The most used emoji
        \item What new words are introduced
    \end{itemize}
    \item \textbf{Goal}: stronger privacy and rich user experience
\end{itemize}

\subsubsection*{Some Privacy Measures}
\begin{itemize}
    \item Identifiers
    \begin{itemize}
        \item Short-lived
        \item Random
        \item Anonymous
    \end{itemize}
    \item Data collection
    \begin{itemize}
        \item Bucket
        \item Sample
        \item Differential privacy
    \end{itemize}
\end{itemize}

\subsubsection*{Identifier API}
\begin{figure}[h]
\centering
\includegraphics[width=0.75\textwidth]{graphics/identifierapi}
\end{figure}

\subsubsection{Differential Privacy}
\begin{itemize}
    \item A formal way of protecting individual privacy in a group by \textbf{adding noise}
    \item The results from the database with or without an individual must not disclose privacy information of the individual
    \item Add statistically biased noise to data bit which averages out over a large number of data points
    \item A randomized function F is $\epsilon$-differently private if for all data sets $D_{1}$ and $D_{2}$ differing at most by one element and all $S\subseteq Range(F)$
\end{itemize}

\begin{shaded}
$Pr[F(D_{1}\in S)] = e^{\epsilon} \times Pr[(F(D_{2} \in S)]$ where $e^{\epsilon} is 1 + \epsilon$
\end{shaded}

\paragraph{How Much Noise to Add?}
The probabilities of \textit{results with or without an individual} are almost the same. The noise should be a function of $\delta F$ and $\epsilon$

\subsubsection*{How to Generate Noise}
\begin{itemize}
    \item Noise = Random value from the distribution with standard deviation large enough to fill the gap
    \item Using probability distribution
    \item Type of distribution depends on F
    \item F is numeric - Laplace distribution
    \begin{itemize}
        \item $Lap(b) = \frac{1}{2b} exp (\frac{x}{b})$
        \item $Variance = 2b^{2}$
    \end{itemize}
    \item F is categorical - Exponential distribution
\end{itemize}

\subsubsection*{How it Works}
\begin{itemize}
    \item Hash the value so that it becomes a fixed length (125 -$>$ Hash -$>$ 00010100111001)
    \item Add noise by flipping some bits (000101001110001 -$>$ Add Noise - $>$ 010100001110000)
    \item By averaging all the values you will end up with the original hash
    \item The probability of changing 0 to 1 and 1 to 0 is less than the probability of unchanging 0 and 1
\end{itemize}

\subsection{Enterprise Security in iOS}
\subsubsection*{Enterprise Concerns}
\begin{itemize}
    \item Enterprises have to manage devices that may be used to access or store the sensitive enterprise data
    \item This introduces the new security risks e.g. Misplaced devices, lost devices, stolen devices
    \item Basically, the sensitive enterprise data could be at risk
\end{itemize}

\subsubsection*{Enterprise Needs}
\begin{itemize}
    \item Control over devices in a number of ways
    \begin{itemize}
        \item Configuring devices (auto-lock)
        \item Managing data and app restrictions (e.g. no access to camera)
        \item Applying rules (strong passcode, remote wipe)
    \end{itemize}
    \item Users can do unsafe things, so enterprise security can help avoid the issues in the case of BYOD
\end{itemize}

\subsubsection*{Naive Approach}
\begin{itemize}
    \item IT admins can do configurations manually
    \item Unfortunately, there are issues with manual configuration as it is \textit{labour-intensive} and \textit{error-prone}
\end{itemize}

\subsubsection{iOS Configuration Management}
\begin{itemize}
    \item iOS based devices are managed through the creation and installation of configuration profiles
    \item These profiles contain settings configured by an administrator for installation on a user's device
    \item Configuration profiles are centrally managed using
    \begin{itemize}
        \item Apple's iPhone Configuration Utility
        \item Mobile Device Management (MDM) System
    \end{itemize}
\end{itemize}

\subsubsection*{Configuration Profiles}
\begin{itemize}
    \item Used to ensure organisation security policy
    \item An XML property list file (plist)
    \item THe plist data may optionally be signed and encrypted
\end{itemize}

\subsubsection*{Profile Metadata}
\begin{itemize}
    \item The configuration profile metadata includes
    \begin{itemize}
        \item The human-readable name
        \item Description of the profile
        \item Creating organisation
        \item Other fields
    \end{itemize}
    \item The configuration payloads are the most important portions of the profile
\end{itemize}

\begin{figure}[h]
\centering
\caption{Configuration Profile Payload Types}
\includegraphics[width=0.75\textwidth]{graphics/configurationprofilepayloadtypes}
\end{figure}

\paragraph{Removal password} payload indicates the password needs to turn off the configuration profile. Configurations can also be set with 'Never Remove' - have to clear the device to get rid of it.

\paragraph{Passcode policy} specifies how complex a passcode should be. If there is no existing passcode or if it is not complex enough, then the user is asked to set a new passcode.

\subsubsection*{iPhone Configuration Utility}
\begin{itemize}
    \item A graphical utility for iPhone configuration
    \begin{itemize}
        \item It lets administrators create and manage configuration profiles
        \item Self-signed certificate created on the installing device at the first time of run
    \end{itemize}
    \item Installed onto iOS devices via USB connection
    \begin{itemize}
        \item Device specific certificates signed by the root certificate are automatically transferred to the iOS device for facilitating digital signature
    \end{itemize}
    \item Updated via USB, email or web server
    \item Issue: not scalable - only manages a limited number of devices
    \item Apple Configurator: More user friendly version of iPhone Configuration Utility
\end{itemize}

\begin{figure}[h]
\centering
\caption{Apple Configurator vs iPhone Configuration Utility}
\includegraphics[width=0.75\textwidth]{graphics/appleconfigurator}
\end{figure}

\subsubsection{MDM Systems}
\begin{itemize}
    \item Used to manage a large number of devices
    \item Apple offers an MDM system in Lion server through the Profile Manager service
    \item The service works well for workgroups and SMEs
    \item For large organisations, a commercial third party MDM solution would likely work best
    \item 3 Components
    \begin{enumerate}
        \item iOS device
        \item Organisation's MDM server
        \item Apple's Push Notification Service (APNS)
    \end{enumerate}
\end{itemize}

\subsubsection*{How MDM Works}
\begin{itemize}
    \item Devices inform the APNS which topics they are subscribing to
    \item The MD server tells the APNS to publish a notification
    \item The notification is sent to the subscribed devices
    \item The device then establishes a connection to the MDM server over HTTPS
    \item A remote wipe command can be initiated by MDM, Exchange or iCloud
\end{itemize}

\subsubsection*{Enterprise Apps}
\begin{itemize}
    \item An enterprise provisioning profile can be loaded along with the configuration profile
    \item Then, the in-house enterprise apps can be distributed Over the Air (OTA) or through MDM
    \item Enterprise provisioning profiles have to be renewed annually
\end{itemize}

\subsubsection*{Kill Switch \& Hardware Modifications}
\begin{itemize}
    \item The kill switch worries some companies, what if Apple wants to shut our apps down?
    \item Some companies do not trust software restrictions - instead of relying on configuration profiles, companies can purchase special hardware
\end{itemize}

\subsection{iOS Jailbreaking}
\begin{itemize}
    \item Removing certain security restrictions, put by Apple, on iOS devices by manipulating the software stack
    \item Provides full access to the OS and filesystem
    \item Using installers like Cydia, it enables installation of apps and themes not approved by Apple
    \item Jailbreaking is legal in the United States - DMCA 2010 but can void the warranty
    \item People jailbreak their iOS devices for many reasons
    \begin{itemize}
        \item Install third-party software not supported by Apple
        \item An open platform for developing software
        \item To bypass cellular carrier locks
        \item To evaluate the security and discover vulnerabilities
    \end{itemize}
\end{itemize}

\begin{figure}[h]
\centering
\caption{iOS Chain of Trust}
\includegraphics[width=0.5\textwidth]{graphics/chainoftrust}
\end{figure}

\subsubsection*{How to Jailbreak}
\begin{itemize}
    \item \textbf{Goal}: To be able to run unsigned code and change filesystem
    \item Bypass kernel-level checks
    \item \textbf{Attack using exploit}
    \begin{itemize}
        \item Buffer overflow
        \item ROP
        \item Disable DEP
    \end{itemize}
    \item \textbf{Kernel patch}
    \begin{itemize}
        \item Modifying file system
        \item Disabling code signing
        \item Changing behaviour of sandbox
        \item Disabling MAC policies
    \end{itemize}
\end{itemize}

\subsubsection{Exploit Types}
\begin{itemize}
    \item The location of a vulnerability impacts the access level
    \item Vary from the device hardware to its software
    \item There are three levels of exploits
    \begin{enumerate}
        \item Bootrom level
        \item iBoot level
        \item Userland level
    \end{enumerate}
\end{itemize}

\subsubsection*{Bootrom Level}
\begin{itemize}
    \item Vulnerabilities inside the hardware
    \item The most powerful vulnerabilities from the point of view of a jailbreaker (allows jailbreakers to modify the whole bootchain)
    \item Cannot be fixed by any software update
    \item Can be fixed only within the next hardware revision
    \item Famous exploits - SHAtter, Limera1n
\end{itemize}

\paragraph{Limera1n}is a heap-based buffer overflow in the USB Data Firmware Upgrade (DFU) stack of the bootrom
\begin{itemize}
    \item Connect the machine to a computer via USB
    \item Force into DFU mode
    \item User the overflow to run the code that can patch the signature verification code
    \begin{itemize}
        \item Boot of a ramdisk
        \item Run the patched version of the low-level bootloader and kernel
        \item These patches allow execution of unsigned code
    \end{itemize}
    \item This is only a tethered jailbreak but it can be used to create an untethered one
\end{itemize}

\subsubsection*{iBoot Level}
\begin{itemize}
    \item Vulnerabilities inside iBoot
    \item As powerful as that of the bootrom in terms of features - still early in the boot process
    \item Since iBoot is not baked into the hardware, they can be fixed by software upgrade
    \item Famous exploit - iH8sn0w (A5 iBoot exploit)
\end{itemize}

\subsubsection*{Userland Level}
\begin{itemize}
    \item Vulnerabilities in userland processes
    \item Less powerful
    \item Easier to fix
    \item These processes can run with any permissions
    \begin{itemize}
        \item Root user - system processes
        \item Mobile user - user applications
    \end{itemize}
    \item In both cases, at least two exploits required to jailbreak the device
    \begin{enumerate}
        \item Achieve arbitrary code execution
        \item Escalate privileges
    \end{enumerate}
\end{itemize}

\subsubsection{Kinds of Jailbreaks}
\begin{itemize}
    \item Depending on the vulnerabilities used, there are two kinds of jailbreaks with respect to jailbreak persistence
    \begin{itemize}
        \item Tethered jailbreaks: Disappears when the device is restarted (e.g. RedSn0w)
        \item Untethered jailbreaks: Permanent (e.g. pandora)
        \item Semi-tethered
        \item Semi-untethered
    \end{itemize}
\end{itemize}

\subsubsection*{Tethered Jailbreak}
\begin{itemize}
    \item The jailbreaks has to be enabled every time the device restarts
    \item The device has to be connected to a computer via a USB cable
    \item Kernel patched each time after reboot
    \item Exploit against privileged code (USB device driver)
    \item Exploit against unprivileged code + privilege escalation exploit
\end{itemize}

\subsubsection*{Untethered Jailbreak}
\begin{itemize}
    \item Permanent effect
    \item Harder to do because it needs to make permanent changes to the boot sequence
    \item Used to beasy when there was a vulnerability in the bootorm
    \item Now requires multiple exploits
    \begin{itemize}
        \item Start with a tethered jailbreak - unsigned code needs to be executed
        \item Find a way to install additional exploits on the root file system - privileges need to be escalated to patch the kernel
    \end{itemize}
\end{itemize}

\subsubsection{Jailbreakme 2.0 Star}
\begin{itemize}
    \item Userland exploit
    \item Go to the website and ajilbreak your phone without attaching it to a computer or rebooting
    \item Stack overflow when MobileSafari handled a particular font - the error was in the FreeType parser when rendering PDFs
    \item This allowed the exploit to mount ROP within MobileSafari
    \item This sophisticated payload proceeded to exploit another vulnerability to increase its level of access
    \item The second vulnerability was an integer overflow in an IOSurface property
    \begin{itemize}
        \item IOSurface is a private framework to share graphics between processes
        \item The second attack allowed code execution inside the kernel
    \end{itemize}
    \item From the kernel, disabled code signing
    \item The ROP downloaded an unsigned library that jailbroke the device
\end{itemize}

\subsubsection{Jailbreaking can be Dangerous}
\begin{itemize}
    \item Disables almost all security features
    \begin{itemize}
        \item Code signing - unsigned code can run
        \item Attack surface is increased
        \item Shell and other utilities added
        \item Can install root privileged code
        \item Unsigned apps are not sandboxed
    \end{itemize}
    \item Jailbreaking essentially reduces iOS security and makes devices vulnerable to different worms
    \item Example: Ikee worm
    \begin{itemize}
        \item Many jailbroken phones had an SSH Server installed
        \item Did not change the default root password \textit{alpine}
        \item SSH server was not sandboxed
        \item What did the worm do?
        \begin{itemize}
            \item Originally changed the wallpaper
            \item Later, it was used to lock the phone, steal contents and create botnets
        \end{itemize}
    \end{itemize}
\end{itemize}


\newpage
\section{Seminars}
\subsection{Stack Overflow Considered Harmful? The Impact of Copy \& Paste on Android Application Security}
\subsubsection*{[Fischer SP17]}
\textbf{StackOverflow} is a great place to get code snippets for all situations, including security-related situations. How safe is it to copy/paste such code into production software?

\subsubsection*{Grabbing code snippets}
\begin{enumerate}
	\item Download code from SO (all of them are in code tags)
	\item Determine if code is security related. Code is security related if it has calls to: \begin{itemize}
		\item Cryptography APIs
		\item Secure network communication APIs
		\item Public key infrastructure APIs
		\item Authentication/access control APIs
		\item BouncyCastle/SpongyCastle
		\item \texttt{HttpClient}
		\item Other libraries such as \texttt{jaspyt} or GNU Crypto
	\end{itemize}
	\item Classify code security. Manually analyze samples to train a machine learning algorithm (\textbf{Support Vector Machine}). 1360 snippets were classified.
\end{enumerate}

\begin{shaded}
\textbf{Code security}\\
\begin{multicols}{2}
Secure code snippets contained:
\begin{itemize}
	\item Good algorithm choice
	\item Secure length of keys
	\item Secure RNG
\end{itemize}
\vfill\null
\columnbreak

They were insecure if they had:
\begin{itemize}
\item Outdated algorithms
\item Static IVs/keys
\item Weak key lengths
\item Insecure RNG
\item Insecure TLS implementations	
\end{itemize}
\end{multicols}

\end{shaded}

Out of the 1360 snippets, 420 were insecure. This classifier was then applied to the rest of the snippets from questions and answers. 

\subsubsection*{Finding C/P code in real world apps}
The StackOverflow code was compiled into the same intermediate representation in DEX files with \textbf{WALA}. 85.2\% of answer snippets were converted. An exact match wasn't needed.\\

A program dependency graph (PDG) was made for each method. Data-independent subgraphs of a method are \textbf{semantic blocks}, and code similarity was given by the number of shared semantic blocks which share constants and method names. This process is automated.

\subsubsection*{Results}
\begin{itemize}
	\item Scraped over 4000 security related Android code snippets. About 30\% of them were insecure.
	\item Downloaded over 1.3 million free apps from the Play Store. 200k of them had SO code snippets; 196k (15\% of total) had at least one insecure snippet.
	\item The top offending snippet had to do with \texttt{TrustManager} with no server verification which could allow for MITM attacks.
\end{itemize}

\subsubsection*{Criticism}
Security is more than just algorithm and key-length. ML can't understand code yet so it could miss vulnerabilities. Code without context can result in an insecure labelling even if it's not used for security purposes.


\subsection{Cloak and Dagger: From Two Permissions to Complete Control of the UI Feedback Loop}
\subsubsection*{[Fratantonio SP17]}

The main point is to do malicious things to the user's phone without them being aware of it. Examples are: stealing logins, installing apps, clicking on ads, calling foreign numbers. This is done by \textbf{controlling the UI feedback loop} and manipulating what the user sees.

\begin{shaded}
\textbf{Dangerous permissions}\\

This vulnerability uses two Android permissions:
\begin{itemize}
	\item \texttt{SYSTEM\_ALERT\_WINDOW} is a permission that needs to be manually enabled but is automatically granted if downloaded from the Google Play Store. It is used to allow drawing over other apps' windows.
	\item \texttt{BIND\_ACCESSIBILITY\_SERVICE} is intended for accessibility-related apps. It can listen for click events and notifications in other apps, scroll and click for the user, and gives access to the full view tree. This isn't automatically granted but does not show up when installing. 
\end{itemize}

Both permissions are required for the attack. With only the first one, the attacker can modify what the user sees but can't react to their actions. With only the second one, the attacker can inject fake input but the user will know that they're being attacked.
\end{shaded}

\subsubsection*{Existing preventative measures}
If an overlay (from \texttt{SYSTEM\_ALERT\_WINDOW}) is being used as a \textbf{pass-through}, the app can't detect touches in its overlay. It is not possible then to overlay a transparent view and steal touches. However, it is possible to detect touches outside the overlay without coordinates (outside clicks set to (0,0)).\\

The \texttt{BIND\_ACCESSIBILITY\_SERVICE} permission needs to be explicitly enabled by the user and doesn't give access to passwords in the view tree.\\

\textbf{Clickjacking.} Apps can detect if a view is being overlaid, so instead we can overlay everything else and change the look of the overlay!\\ 

We can play a video in an overlay, and in the background install a malicious app and grant it permissions.\\

\subsubsection*{Keystroke inference}
We can read keystrokes with \texttt{SYSTEM\_ALERT\_WINDOW} by creating a passthrough overlay per key and stack them on each other. Each overlay has a flag to detect if it's being obscured, and to detect if an outside touch occurred. The lowest overlay that isn't obscured is the desired key. Overlays could also be used for fake login fields or ads.

\subsubsection*{User study}
20 university staff were asked to participate and install an app. None of them realized that they were being attacked; in the background an app was being installed.

\subsubsection*{Proposed fixes}
\begin{itemize}
	\item Allow apps to be marked \textbf{security-sensitive} so that they can't be drawn over. Don't let accessibility services click/enter text. (This would break apps like LastPass).
	\item Don't automatically grant \texttt{SYSTEM\_ALERT\_WINDOW}.
	\item Check apps that use both permissions.
	\item Display permissions at install-time.
\end{itemize}
From Android 8.0 onwards, apps can't draw over system views such as the notification bar. Notifications are also shown if an app is drawing an overlay.\\

Google is also limiting use of Accessibility Services for non-accessibility purposes.\\

Restricting overlays can be detrimental to user experience (chat heads!).

\subsection{The ART of App Compartmentalization: Compiler-based Library Privilege Separation on Stock Android}
\subsubsection*{[Huang CCS17]}
Developers use software libraries, such as platform libraries but also third-party libraries. Third-party libraries are used to either solve a problem (such as a physics engine), or for monetization (ad library/service).\\

Libraries run with the \textbf{same privileges} and in the \textbf{same sandbox} as the application. This could lead to data leakage and greater exposure to vulnerabilities. A library exploit could lead to an exploit in the app.\\

\begin{figure}[h!]
\centering
\caption{System overview of CompARTist}
\includegraphics[width=0.9\textwidth]{graphics/compartment}
\end{figure}

The solution is to move the library into its own sandbox and to interconnect it with the host application with the Binder.\\

\subsubsection*{IPC}
Libraries rarely implement \texttt{Parcelable}, so transferring the original classes isn't an option. Authors implement \texttt{WrapClass} that is used by \texttt{AdHelper} to replicate access to objects to the other end.
\begin{figure}[h!]
\centering
\caption{Inter-application communication channel}
\includegraphics[width=0.7\textwidth]{graphics/IACC}
\end{figure}

The idea is to rewrite the app code during compilations to use \texttt{AdHelper} and IPC. First, entry points must be identified, then rewrite the code by traversing entry points down the call graph. Finally, the \texttt{AdHelper} library is injected.\\

In short, the app is split into a host and the ad app. IPC is used as communication between the two apps. Instrumentation replaces calls to the third-party library with calls to \texttt{AdHelper} that calls the ad app. Layout synchronization replicates GUI state.\\

Start-up is slow because IPC has to be initialized.

\subsubsection*{Criticisms}
This approach works for loosely coupled libraries, but would have high performance overhead for tightly coupled libraries.\\

This requires root privileges to replace the \texttt{OAT} files in the original app.\\

Advertisement companies might not care?



\subsection{Unleashing the Walking Dead: Understanding Cross-App Remote Infections on Mobile WebViews}
\subsubsection*{[Li CCS17]}
A \textbf{WebView} is an in-app browser that runs in the current app to load some content. This is convenient for users. When a URL in an app is triggered, it sends an intent to another app which redirects its WebView to load the URL content.\\

An \textbf{intent} is an abstract description of an operation to be performed.\\

Cross-app webview navigation (XAWN) can be intent-based through an \textbf{implicit scheme} (locates targeted apps through intent) or an \textbf{explicit scheme} (targeted towards a specific app). \textbf{Deep linking} links to a specific location within an app.\\

\subsubsection*{The Problem}
Navigations aren't guarded extensively by the mobile OS. They are protected solely on intent permissions and filters.\\

Security for WebViews are difficult to implement. Android provides domain controlling methods such as \texttt{shouldOverrideUrlLoading()} and \texttt{onPageStarted()} but they can be circumvented\\

XAWN weakness exploited through transition of apps.

\subsubsection*{Cross-App WebView infection}
This attack attempts to gain control, privileges, and user information of the hosting application. The attack infects the entry point app and then spreads from the remote adversary.

\paragraph{Phishing} Attempt to obtain sensitive information by disguising as a trustworthy entity in electronic communication.

\paragraph{Remote Deep Phishing} Facebook has a URL bar to show source of web content, so phishing can't take place. Twitter doesn't, so by infecting the Twitter UI, the app can display a fake login UI to impersonate Facebook.\\

When the user opens Facebook, the app isn't displayed but the infected WebView instantly invokes Twitter's WebView with a phishing login page. Once the user ``logs in,'' Facebook's main activity is displayed.

\paragraph{Remove Privilege Escalation} Install malware and sends messages without user consent after clicking a link.

\subsubsection*{Solution}
\textbf{ViewFinder} is a simple fuzzing system that scans apps for remotely-controllable WebView instances. Its code and manifest files are checked to find malicious intents. Out of 5000 apps, 7.4\% of them that receive intents from other apps were found to have vulnerable WebViews.\\

\textbf{NaviGuard} identifies and controls anomalous cross-WebView navigation requests. It prevents navigation without user permission and notifies users about the automated navigation.

\subsubsection*{Criticisms}
Apps were challenging to use. NaviGuard was only tested on a specific model.

\subsection{Hindsight: Understanding the Evolution of UI Vulnerabilities in Mobile Browsers}
\subsubsection*{[Luo CCS17]}

\subsection{[Nguyen CCS17]}

\subsection{[Papadopoulos WWW17]}

\subsection{[Ren NDSS17]}

\subsection{[Song SP17]}

\subsection{[Xue USENIX-Security17]}

\subsection{[Ye NDSS17]}

\subsection{[Zhang INFOCOM17]}

\subsection{[Zuo WWW17]}
\end{document}
